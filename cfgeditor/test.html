<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cfgeditor</title>
  </head>
  <body>
    <div id="root"></div>
    <input type="button" onclick="VideoAddCaption()" value="Demo">

    <h2>try yourself</h2>

    <div id="result"></div>

    <script>
      const TestVideoSrc = "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
      const TestSRTText = `
1
00:00:00.000 --> 00:00:02.500
剧名：虫群

2
00:00:02.500 --> 00:00:14.500
a little <i>在剩下的航程中</i>
?我们会回味与你的谈话 艾佛亚博士


`

      async function VideoAddCaption(videoSrc = null, captionFile=null) {
        if (videoSrc === null) {
          videoSrc = TestVideoSrc
        }
        let captionContent = ""
        if (captionFile === null) {
          captionContent = TestSRTText
        } else {
          const reader = new FileReader()
          await new Promise(resolve => {
            reader.onload = (e) => {
              const content = e.target.result
              captionContent = content
              console.log(content);
              resolve()
            }
            reader.readAsText(captionFile)
          })
        }
        if (captionContent.substring(0, 6) !== "WEBVTT") { // 👈
          console.log("Add HEADER: WEBVTT")
          captionContent = "WEBVTT\n" + captionContent
        }
        console.log(captionContent);
        const blobCaption = new Blob([captionContent])
        const captionBlobURL = URL.createObjectURL(blobCaption)
        console.log(captionBlobURL);
        const frag = document.createRange().createContextualFragment(`
        <video width="600" height="400" controls>
        <source src="${videoSrc}" type="video/mp4">
        <track src="${captionBlobURL}" kind="captions" srclang="en" label="zh_TW" default>
        </video>
        `)
        const resultElem = document.querySelector("div#result")
        resultElem.innerHTML = ""
        resultElem.append(frag)
      }
      document.querySelector("input[type=file]").onchange = async (e) => {
        const captionFile = e.target.files[0]
        VideoAddCaption(TestVideoSrc, captionFile)
      }
    </script>

  </body>
</html>
